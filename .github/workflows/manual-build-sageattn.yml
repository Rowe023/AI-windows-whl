name: Manual SageAttention Builder

on:
  workflow_dispatch:
    inputs:
      sage_attn_version:
        description: 'SageAttention version (e.g., v2.2.0-windows.post2 or "latest")'
        required: true
        type: string
        default: 'latest'
      # 新增：自定义Python版本（匹配你的3.13）
      python_version:
        description: 'Python version (e.g., 3.13)'
        required: true
        type: string
        default: '3.13'
      # 新增：自定义PyTorch版本（匹配你的2.9.1）
      torch_version:
        description: 'PyTorch version (e.g., 2.9.1)'
        required: true
        type: string
        default: '2.9.1'
      # 新增：自定义CUDA版本（编译用，匹配你的13.0/13.1）
      cuda_version:
        description: 'CUDA version (e.g., 13.0)'
        required: true
        type: string
        default: '13.0'

jobs:
  build-wheel:
    name: Build SageAttention Wheel
    runs-on: windows-2022

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # 修改：使用自定义的Python版本（不再固定3.13）
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python_version }}

      # 修改：使用自定义的CUDA版本（不再固定13.0.0）
      - name: Install CUDA Toolkit
        uses: N-Storm/cuda-toolkit@v0.2.27m
        with:
          cuda: ${{ inputs.cuda_version }}.0  # 拼接成完整版本（13.0 → 13.0.0）
          method: 'network'
          use-github-cache: false
          use-local-cache: false

      - name: Setup MSVC Developer Command Prompt
        uses: TheMrMilchmann/setup-msvc-dev@v4
        with:
          arch: x64

      - name: Install build dependencies
        shell: pwsh
        run: python -m pip install -U setuptools wheel packaging ninja

      # 修改：传递自定义的Python/PyTorch/CUDA参数到编译脚本
      - name: Build wheel
        id: build_wheel
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          .\.github\scripts\build_sage_attention_windows.ps1 -SageAttnVersion "${{ github.event.inputs.sage_attn_version }}" `
                                                             -PythonVersion "${{ github.event.inputs.python_version }}" `
                                                             -TorchVersion "${{ github.event.inputs.torch_version }}" `
                                                             -CudaVersion "${{ github.event.inputs.cuda_version }}"

      # 后续步骤（测试安装、上传artifact）保持不变
      - name: Test wheel installation
        shell: pwsh
        run: |
          pip install --no-cache-dir ${{ steps.build_wheel.outputs.wheel_path }}
          python -c "import sage_attn; print('Successfully imported sage_attn version:', sage_attn.__version__)"

      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sage-attention-wheel
          path: ${{ steps.build_wheel.outputs.wheel_path }}
